#!/usr/bin/env perl -T

use strict;
use warnings;
use File::Copy "cp";

# Untaint a path safely
sub untaint_path {
    my ($path) = @_;
    if ($path =~ /^([-\/\w\.\_]+)$/) {
        return $1;
    }
    die "Insecure path detected: $path";
}

# Load and untaint configuration
our ($date, $domainName, $dnshome, $serverIP, $mailer);
require "/var/named/etc/dennis.conf";

$ENV{PATH} = '/bin:/usr/bin'; # Set a safe execution path

# Untaint config values
if ($date =~ /^(.*)$/s) { $date = $1; } else { die "Tainted date: $date"; }
if ($domainName =~ /^(.*)$/s) { $domainName = $1; } else { die "Tainted domainName: $domainName"; }
if ($serverIP =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) { $serverIP = $1; } else { die "Tainted serverIP: $serverIP"; }
if ($mailer =~ /^([-\/\w\.\_]+)$/) { $mailer = $1; } else { die "Tainted mailer path: $mailer"; }
$dnshome = untaint_path($dnshome);
chomp($date);

my $fileBuildLock = untaint_path("$dnshome/locks/createSecondary.lock");
my $fileDNSBuildLock = untaint_path("$dnshome/locks/dnsBuild.lock");
my $fileNamedConf = untaint_path("$dnshome/secondary/named.conf");
my $contactName = "hostmaster\@$domainName";

# --- Subroutine Declarations ---
sub reverseZone;

# --- Main Logic ---
if (-e $fileDNSBuildLock) {
    die "ERROR: DNS is currently rebuilding. Cannot create named.conf now.\n";
}
if (-e $fileBuildLock) {
    die "ERROR: createSecondary is already running.\n";
}

open(my $lock_fh, '>', $fileBuildLock) or die "Cannot create lock file $fileBuildLock: $!";
close($lock_fh);

my $zoneDate;
if ($date =~ /^([\w\.\-:]+)$/) {
    $zoneDate = $1;
} else {
    die "Tainted date string for backup: $date";
}
my $oldNamedConf = untaint_path("$fileNamedConf.secondary.$zoneDate");

if (-f $fileNamedConf) {
    cp($fileNamedConf, $oldNamedConf) or die "Failed to copy $fileNamedConf to $oldNamedConf: $!";
}

open(my $nb_fh, '>', $fileNamedConf) or die "Cannot open file $fileNamedConf for writing: $!";
print $nb_fh "// named.conf for domain $domainName - secondary server\n\n";

# Forward zone
printf $nb_fh "zone \"%s\" {\n", $domainName;
print $nb_fh "\ttype slave;\n";
printf $nb_fh "\tfile \"slaves/%s\";\n", $domainName;
printf $nb_fh "\tmasters { %s; };\n", $serverIP;
print $nb_fh "};\n\n";

# Reverse zones
my $master_dir = untaint_path("$dnshome/master");
opendir(my $dh, $master_dir) or die "Cannot open directory $master_dir: $!";
my @zonefiles = readdir($dh);
closedir($dh);

for my $zone_tainted (@zonefiles) {
    next if $zone_tainted =~ /^\.\.?$/;
    next if $zone_tainted =~ /\Q$domainName\E/ or $zone_tainted eq '127.0.0';

    my $zone;
    if ($zone_tainted =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) {
        $zone = $1;
    } else {
        next;
    }

    my $reversezone = reverseZone($zone);
    printf $nb_fh "zone \"%s.in-addr.arpa\" {\n", $reversezone;
    print $nb_fh "\ttype slave;\n";
    printf $nb_fh "\tfile \"slaves/db.%s\";\n", $zone;
    printf $nb_fh "\tmasters { %s; };\n", $serverIP;
    print $nb_fh "};\n\n";
}
close($nb_fh);

# Compare with backup and notify if changed
my $files_differ = 0;
if (-f $oldNamedConf) {
    open(my $cmp_fh, '-|', 'cmp', $fileNamedConf, $oldNamedConf) or die "Cannot compare files";
    my $status = <$cmp_fh>;
    close($cmp_fh);
    if (defined $status) {
        $files_differ = 1;
    } else {
        unlink($oldNamedConf); # No differences, remove backup
    }
} else {
    $files_differ = 1; # New file, so it has "changed"
}

if ($files_differ) {
    open(my $mail_fh, '|-', $mailer, '-t') or die "Cannot open pipe to mailer: $!";
    print $mail_fh "To: $contactName\n";
    print $mail_fh "From: dnsBuild\@$domainName\n";
    print $mail_fh "Subject: New named.conf for secondary named servers\n\n";
    print $mail_fh "The named.conf has been updated. Please get the latest file via the network.\n";
    close($mail_fh);
    print "Mailing new secondary DNS named.conf to $contactName\n";
}

unlink($fileBuildLock) or die "Cannot remove file $fileBuildLock: $!";

# --- Subroutines ---
sub reverseZone {
    my ($ip) = @_; # Assumes untainted segment strings
    my @arrayip = split(/\./, $ip);
    return join ".", reverse(@arrayip);
}
