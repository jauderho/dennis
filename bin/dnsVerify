#!/usr/bin/env perl -T

use strict;
use warnings;

# Untaint a path safely
sub untaint_path {
    my ($path) = @_;
    if ($path =~ /^([-\/\w\.\_]+)$/) {
        return $1;
    }
    die "Insecure path detected: $path";
}

# Load and untaint configuration
our ($fileHosts);
require "/var/named/etc/dennis.conf";

$ENV{PATH} = '/bin:/usr/bin'; # Set a safe execution path
$fileHosts = untaint_path($fileHosts);

my @dnsArray;
my @outArray;

# Read hosts file
open(my $dns_fh, '<', $fileHosts) or die "Cannot open $fileHosts: $!";
@dnsArray = <$dns_fh>;
close($dns_fh);

sub checkIP {
    my ($lines) = @_;
    my %seenIP;
    for my $line (@$lines) {
        chomp($line);
        $line =~ s/#.*//;
        next if $line =~ /^\s*$/;

        my ($ip_tainted, @names_tainted) = split(/\s+/, $line);
        next unless defined $ip_tainted;

        if ($ip_tainted !~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) {
            warn "WARNING: bad format\t    $line\n";
            next;
        }
        my $ip = $1;

        my @octets = split(/\./, $ip);
        if (grep { $_ > 255 } @octets) {
            warn "WARNING: invalid IP\t    $ip\n";
        }

        if ($seenIP{$ip}++) {
            push @outArray, "WARNING: dupe IP\t$ip";
        }
    }
}

sub checkHosts {
    my ($lines) = @_;
    my %seenHosts;
    my %holderHosts;
    my %dupHosts;

    for my $line (@$lines) {
        chomp($line);
        $line =~ s/#.*//;
        next if $line =~ /^\s*$/;

        my ($ip_tainted, @names_tainted) = split(/\s+/, $line);
        next unless defined $ip_tainted && @names_tainted;

        my $ip;
        if ($ip_tainted =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) {
            $ip = $1;
        } else {
            next;
        }

        for my $hostname_tainted (@names_tainted) {
            if ($hostname_tainted !~ /^([\w\-\.]+)$/) {
                # Optionally warn about invalid characters
                next;
            }
            my $hostname = $1;

            $seenHosts{$hostname}++;
            $holderHosts{$hostname} //= $ip; # Store first IP seen

            if ($seenHosts{$hostname} > 1) {
                $dupHosts{$hostname} //= "$holderHosts{$hostname} ";
                $dupHosts{$hostname} .= "$ip " unless $dupHosts{$hostname} =~ /\Q$ip\E/;
            }
        }
    }

    for my $hostname (keys %dupHosts) {
        push @outArray, "WARNING: multiple IP\t" . sprintf("%-16s", $hostname) . $dupHosts{$hostname};
    }
}


checkIP(\@dnsArray);
checkHosts(\@dnsArray);

# Print everything
if (@outArray) {
    print join("\n", sort @outArray), "\n";
}
